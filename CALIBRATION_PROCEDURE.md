# K10-3U8 电压采集模块校准操作步骤

## 准备工作

### 硬件准备
1. **精密电压源** - 以下任一种即可：
   - 精密可调电源（推荐，如优利德 UTP3305）
   - 数字万用表 + 稳压电源（用万用表测量实际电压）
   - 电压基准模块（如 LM4040-5.0 提供精确 5V）

2. **连接线材：**
   - 杜邦线或测试探针
   - 确保接触良好，避免接触电阻

3. **测试环境：**
   - 静电手环（可选）
   - 稳定的工作台
   - 避免强电磁干扰

### 软件准备
1. **串口监控工具：** 打开 COM24（USB-Serial-JTAG）
2. **固件已烧录：** 确保已烧录包含校准功能的固件
3. **记录表格：** 准备记录测量数据

## 校准步骤详解

### 第一步：零点校准（0V 测量）

#### 1.1 硬件连接
```
K10-3U8 模块：
┌─────────────────┐
│ AI1  ────────┐  │
│ AI2  ────────┤  │
│ AI3  ────────┤  │
│ AI4  ────────┼──┼─→ 接到 AGND
│ AI5  ────────┤  │
│ AI6  ────────┤  │
│ AI7  ────────┤  │
│ AI8  ────────┘  │
│                 │
│ AGND ───────────┼─→ 连接到 GND
└─────────────────┘
```

**操作：**
- 将所有 AI1~AI8 的输入端连接到 AGND（模块的模拟地）
- 确保 AGND 和 ESP32-S3 的 GND 已连接

#### 1.2 读取零点数据
打开串口监控，等待自动读数（每 2 秒一次），记录数据：

```
示例日志输出：
VADC: === Voltage Values (工程量，单位 mV) ===
VADC:   AI1: Raw=    5 =     5 mV ( 0.005 V)
VADC:   AI2: Raw=    3 =     3 mV ( 0.003 V)
VADC:   AI3: Raw=    0 =     0 mV ( 0.000 V)
VADC:   AI4: Raw=    2 =     2 mV ( 0.002 V)
VADC:   AI5: Raw=    7 =     7 mV ( 0.007 V)
VADC:   AI6: Raw=    1 =     1 mV ( 0.001 V)
VADC:   AI7: Raw=    4 =     4 mV ( 0.004 V)
VADC:   AI8: Raw=    6 =     6 mV ( 0.006 V)
```

#### 1.3 记录零点偏移
填入下表：

| 通道 | 理论值 | 实测值 (mV) | 零点偏移 (mV) |
|------|--------|-------------|---------------|
| AI1  | 0      | 5           | -5            |
| AI2  | 0      | 3           | -3            |
| AI3  | 0      | 0           | 0             |
| AI4  | 0      | 2           | -2            |
| AI5  | 0      | 7           | -7            |
| AI6  | 0      | 1           | -1            |
| AI7  | 0      | 4           | -4            |
| AI8  | 0      | 6           | -6            |

**计算公式：** `零点偏移 = 理论值 - 实测值 = 0 - 实测值`

---

### 第二步：满量程校准（5V 或 9V 测量）

#### 2.1 硬件连接（推荐用 5V）

**方案 A：使用可调电源**
```
可调电源
┌────────┐
│  +5.000V├───┬─→ AI1
│         │   ├─→ AI2
│    GND  ├─┐ ├─→ AI3
└────────┘ │ ├─→ AI4
           │ ├─→ AI5
           │ ├─→ AI6
           │ ├─→ AI7
           │ └─→ AI8
           │
           └─→ AGND (K10-3U8)
```

**方案 B：使用万用表监控**
```
稳压电源 (约5V)
    │
    ├─→ 万用表 (+) 
    │      │
    │      └─→ AI1, AI2, ..., AI8 (并联)
    │
    └─→ GND ─→ 万用表 (-) ─→ AGND
```

**操作步骤：**
1. 调整电源输出到 **5.000V**（用万用表确认实际电压）
2. 将正极分别或同时连接到各个 AI 通道
3. 负极连接到 AGND

⚠️ **重要：记录万用表测量的实际电压值！** 例如：万用表显示 4.998V

#### 2.2 读取满量程数据

**方案 A：逐个通道测量（更准确）**
```
1. 只连接 AI1 到 5V，记录读数
2. 断开 AI1，连接 AI2 到 5V，记录读数
3. 依次类推...
```

**方案 B：同时测量（更快）**
```
将所有 AI1~AI8 并联到同一 5V 源，同时记录
```

示例日志输出：
```
VADC: === Voltage Values (工程量，单位 mV) ===
VADC:   AI1: Raw= 5050 =  5050 mV ( 5.050 V)
VADC:   AI2: Raw= 4995 =  4995 mV ( 4.995 V)
VADC:   AI3: Raw= 5002 =  5002 mV ( 5.002 V)
VADC:   AI4: Raw= 5010 =  5010 mV ( 5.010 V)
VADC:   AI5: Raw= 4988 =  4988 mV ( 4.988 V)
VADC:   AI6: Raw= 5020 =  5020 mV ( 5.020 V)
VADC:   AI7: Raw= 4998 =  4998 mV ( 4.998 V)
VADC:   AI8: Raw= 5005 =  5005 mV ( 5.005 V)
```

#### 2.3 记录满量程数据
假设万用表测量实际电压为 **4998 mV**，填表：

| 通道 | 实际电压 (mV) | 模块读数 (mV) | 误差 (mV) | 增益误差 (%) |
|------|---------------|---------------|-----------|--------------|
| AI1  | 4998          | 5050          | +52       | +1.04%       |
| AI2  | 4998          | 4995          | -3        | -0.06%       |
| AI3  | 4998          | 5002          | +4        | +0.08%       |
| AI4  | 4998          | 5010          | +12       | +0.24%       |
| AI5  | 4998          | 4988          | -10       | -0.20%       |
| AI6  | 4998          | 5020          | +22       | +0.44%       |
| AI7  | 4998          | 4998          | 0         | 0.00%        |
| AI8  | 4998          | 5005          | +7        | +0.14%       |

---

### 第三步：计算校准参数

#### 3.1 简化方案（仅校准零点偏移）
如果增益误差 < ±1%，可以忽略增益校准，只校准零点：

**公式：** `offset = 零点偏移 - (满量程误差 * 零点电压/满量程电压)`

对于 0V 和 5V 两点校准：
```
offset ≈ 零点偏移 - 满量程误差 * (0/5000) = 零点偏移
```

**简化后：直接使用零点偏移即可**

示例（AI1）：
```c
// AI1: 零点偏移 = -5 mV
voltage_adc_set_calibration(0, 1.0f, -5);
```

#### 3.2 完整方案（同时校准零点和增益）

如果增益误差 > ±1%，需要计算增益系数：

**增益计算公式：**
```
gain = 实际电压 / 模块读数
```

示例（AI1）：
```
实际电压 = 4998 mV
模块读数 = 5050 mV（已扣除零点偏移 -5）= 5050 - (-5) = 5055 mV

gain = 4998 / 5055 = 0.9887
```

**最终参数：**
```c
// AI1: gain=0.9887, offset=-5
voltage_adc_set_calibration(0, 0.9887f, -5);
```

#### 3.3 实际案例（基于您的测试数据）

您的测试：4.62V 输入时
- AI1 读数：4801 mV → 误差 +181 mV
- AI4 读数：4612 mV → 误差 -8 mV

**AI1 校准参数：**
```c
// 方案1：简单偏移校正（推荐）
voltage_adc_set_calibration(0, 1.0f, -181);

// 方案2：精确增益校正
// gain = 4620 / 4801 = 0.9623
// 但如果零点偏移是 -5 mV，则：
// offset = -5 - 181 * (0/4620) ≈ -5
// 不够准确，建议用方案1
```

---

### 第四步：修改代码添加校准参数

打开文件：`tools/test_jig_firmware/main/voltage_adc.c`

找到函数 `voltage_adc_load_default_calibration()`（约 240 行），修改为：

```c
void voltage_adc_load_default_calibration(void)
{
    ESP_LOGI(TAG, "Loading default calibration parameters...");
    
    // 根据实际测量数据填入每个通道的校准参数
    // voltage_adc_set_calibration(通道号, 增益, 偏移mV);
    
    // AI1: 零点 -5 mV, 满量程 +52 mV 误差
    voltage_adc_set_calibration(0, 1.0f, -5);
    
    // AI2: 零点 -3 mV, 满量程 -3 mV 误差（很准，可不校准）
    // voltage_adc_set_calibration(1, 1.0f, -3);
    
    // AI3: 零点 0 mV, 满量程 +4 mV（很准，可不校准）
    // voltage_adc_set_calibration(2, 1.0f, 0);
    
    // AI4: 零点 -2 mV, 满量程 +12 mV
    voltage_adc_set_calibration(3, 1.0f, -2);
    
    // AI5: 零点 -7 mV, 满量程 -10 mV
    voltage_adc_set_calibration(4, 1.0f, -7);
    
    // AI6: 零点 -1 mV, 满量程 +22 mV
    voltage_adc_set_calibration(5, 1.0f, -1);
    
    // AI7: 零点 -4 mV, 满量程 0 mV（很准）
    // voltage_adc_set_calibration(6, 1.0f, -4);
    
    // AI8: 零点 -6 mV, 满量程 +7 mV
    voltage_adc_set_calibration(7, 1.0f, -6);
    
    ESP_LOGI(TAG, "Calibration loaded.");
}
```

**如何选择要校准的通道：**
- ✅ **必须校准：** 误差 > ±50 mV 的通道
- ⚠️ **建议校准：** 误差 > ±10 mV 的通道
- ✔️ **可选校准：** 误差 < ±10 mV 的通道（已经很准）

---

### 第五步：编译烧录验证

#### 5.1 编译固件
```powershell
cd c:\Users\h1576\Desktop\Roam\pe_code\pe_board\tools\test_jig_firmware
idf.py build
```

#### 5.2 烧录固件
```powershell
idf.py flash
```

#### 5.3 打开监控
```powershell
idf.py monitor
```

或使用串口助手连接 COM24（115200 波特率）

#### 5.4 验证校准效果

**测试 1：零点测试**
- 所有 AI 接到 AGND
- 预期：所有通道读数 ≈ 0 mV (±5 mV 以内)

**测试 2：满量程测试**
- 所有 AI 接到 5V 标准电压
- 预期：所有通道读数 ≈ 实际电压 (±10 mV 以内)

**测试 3：中间值测试**
- 测试 2.5V, 7.5V 等不同电压点
- 验证线性度

示例校准后日志：
```
VADC: === Voltage Values (工程量，单位 mV) ===
VADC:   AI1: Raw= 5050 -> Calibrated= 5045 mV ( 5.045 V) [Gain=1.0000, Offset=-5]
VADC:   AI2: Raw= 4995 =  4995 mV ( 4.995 V)
VADC:   AI3: Raw= 5002 =  5002 mV ( 5.002 V)
VADC:   AI4: Raw= 5010 -> Calibrated= 5008 mV ( 5.008 V) [Gain=1.0000, Offset=-2]
...
```

---

## 快速校准流程（仅针对您当前的问题）

如果您只想快速解决 AI1 和 AI4 的差异问题：

### 1. 准备一个稳定的 4.5V~5V 电压源
用手机充电器 + USB 电压表，或任何可用的稳压电源

### 2. 同时连接 AI1 和 AI4 到这个电压源
```
电压源 (+5V) ──┬─→ AI1
               └─→ AI4
GND ───────────→ AGND
```

### 3. 读取当前数值
假设读到：
```
AI1: 4801 mV
AI4: 4612 mV
```

### 4. 用万用表测量实际电压
假设实际是：**4620 mV**

### 5. 计算偏移量
```
AI1 offset = 4620 - 4801 = -181 mV
AI4 offset = 4620 - 4612 = +8 mV
```

### 6. 修改代码
```c
void voltage_adc_load_default_calibration(void)
{
    ESP_LOGI(TAG, "Loading default calibration parameters...");
    
    voltage_adc_set_calibration(0, 1.0f, -181);  // AI1
    voltage_adc_set_calibration(3, 1.0f, 8);     // AI4
    
    ESP_LOGI(TAG, "Calibration loaded for AI1 and AI4");
}
```

### 7. 编译烧录测试
```powershell
idf.py build flash monitor
```

### 8. 验证
再次连接相同电压，AI1 和 AI4 读数应该接近（差异 < 10 mV）

---

## 常见问题

### Q1: 没有精密电压源怎么办？
**A:** 可以用以下替代方案：
- USB 充电器输出（约 5V）+ 数字万用表测量
- 3.3V 稳压器输出（如 AMS1117-3.3）
- 电池（如 18650 锂电池 ≈ 3.7V）
- 关键是用万用表测量实际电压值

### Q2: 每个通道都要单独测量吗？
**A:** 建议：
- **初次校准：** 单独测量更准确
- **批量验证：** 可以并联测量（但要确保电流足够）

### Q3: 校准参数需要保存吗？
**A:** 当前方案是硬编码在固件中，每次烧录都会加载。
如果需要动态保存，可以用 NVS 存储（见 `CALIBRATION_GUIDE.md`）

### Q4: 校准后还是有误差怎么办？
**A:** 检查：
1. AGND 和 GND 是否连接良好
2. 电压源是否稳定（用万用表实时监控）
3. 接线是否有接触不良
4. 是否需要增益校准（用两点校准法）

### Q5: 多久需要重新校准？
**A:** 建议：
- **初次使用：** 必须校准
- **定期维护：** 每 6~12 个月
- **发现偏差：** 立即重新校准
- **更换模块：** 必须重新校准

---

## 校准记录模板

建议建立校准记录表格：

```
测试治具编号：JIG-001
校准日期：2025-11-10
操作员：XXX
环境温度：25°C

零点测试（0V）：
┌────┬─────────┬──────────┬────────────┐
│通道│ 理论值  │ 实测值   │ 零点偏移   │
├────┼─────────┼──────────┼────────────┤
│AI1 │ 0 mV    │ 5 mV     │ -5 mV      │
│AI2 │ 0 mV    │ 3 mV     │ -3 mV      │
│... │ ...     │ ...      │ ...        │
└────┴─────────┴──────────┴────────────┘

满量程测试（5000 mV）：
┌────┬─────────┬──────────┬──────────┬──────────┐
│通道│ 实际值  │ 模块读数 │ 误差     │ 增益系数 │
├────┼─────────┼──────────┼──────────┼──────────┤
│AI1 │ 4998 mV │ 5050 mV  │ +52 mV   │ 0.9897   │
│AI2 │ 4998 mV │ 4995 mV  │ -3 mV    │ 1.0006   │
│... │ ...     │ ...      │ ...      │ ...      │
└────┴─────────┴──────────┴──────────┴──────────┘

最终校准参数：
AI1: gain=1.0, offset=-5 mV
AI2: gain=1.0, offset=-3 mV
...

验证测试（2500 mV）：
AI1: 2498 mV (OK, 误差 -2 mV)
AI2: 2501 mV (OK, 误差 +1 mV)
...

校准结论：通过 ✓
签名：__________
```

保存此记录以备追溯。
